import pandas as pd
from sklearn.cluster import KMeans
from scipy.cluster.hierarchy import linkage, fcluster
import numpy as np
from sklearn.datasets import make_blobs
import matplotlib.pyplot as plt

X, _ = make_blobs(n_samples=300, centers=4, cluster_std=0.60, random_state=0)
inertias = []
for k in range(1, 11):
    kmeans = KMeans(n_clusters=k, random_state=42, n_init=10)
    kmeans.fit(X)
    inertias.append(kmeans.inertia_)
diff1 = [inertias[i] - inertias[i+1] for i in range(len(inertias)-1)]
diff2 = [diff1[i] - diff1[i+1] for i in range(len(diff1)-1)]
k_opt = np.argmax(diff2) + 3
kmeans = KMeans(n_clusters=k_opt, random_state=42, n_init=10)
kmeans.fit(X)
labels_kmeans = kmeans.labels_
Z = linkage(X, method='ward')
clusters_hier = fcluster(Z, k_opt, criterion='maxclust')

plt.figure(figsize=(12, 5))
plt.subplot(1, 2, 1)
plt.plot(range(1, 11), inertias, marker='o')
plt.title('Elbow Method')
plt.xlabel('Number of clusters')
plt.ylabel('Inertia')
plt.axvline(x=k_opt, color='r', linestyle='--', label=f'Optimal k={k_opt}')
plt.legend()

plt.subplot(1, 2, 2)
plt.scatter(X[:, 0], X[:, 1], c=labels_kmeans, cmap='viridis', marker='o', edgecolor='k', s=50)
plt.title('K-Means Clustering')
plt.xlabel('Feature 1')
plt.ylabel('Feature 2')
plt.colorbar(label='Cluster')

plt.tight_layout()
plt.savefig('clustering_diagram.png')
plt.show()

print(k_opt)
print(labels_kmeans)
print(clusters_hier)
